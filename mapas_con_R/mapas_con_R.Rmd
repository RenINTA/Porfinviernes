---
title: "Haciendo mapas con R"
author: "Dr. Agustín Alesso"
institute: "ICiagro Litoral | UNL-CONICET"
subtitle: "Por fin VieRnes"
date: "11 de Agosto 2023"
output: 
  xaringan::moon_reader:
    seal: false
    lib_dir: libs 
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
    css: ['styles.css', 'fonts.css', 'print.css']
    self_contained: true  #true para cuando se publica
editor_options: 
  chunk_output_type: inline
---
class: title-slide, middle, hide-count, inverse
background-size: 15%
background-position: 10% 90%

```{r setup, include=FALSE}
#Packages
pacman::p_load(knitr, tidyverse, patchwork, xfun, tmap, leaflet, sp, DiagrammeR, ggvenn)
xaringanExtra::use_tile_view()
# xaringanExtra::use_clipboard()

htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
  ),
  rmarkdown::html_dependency_font_awesome()
)

#Options
opts_chunk$set(
  echo = T, comment = NA, warning = FALSE, message = FALSE, fig.align = 'center', cache =F,
  fig.retina = 2
)
options(width = 70)
tema <- theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Functions
source(here::here("./mapas_con_R/out_lines.R"))
```

# `r rmarkdown::metadata$title`

<br>

## `r rmarkdown::metadata$author`
  
### `r rmarkdown::metadata$subtitle`

### `r rmarkdown::metadata$institute`

<br>

### `r rmarkdown::metadata$date`

???

---
## Outline

.pull-left[

-   ¿Por qué hacer mapas? ¿por qué con R?
-   Evolución datos espaciales en R
-   Mapas estáticos vs interactivos
-   base?
-   Paquetes para mapear
-   Referencias

]

???

--

.pull-right[

<br><br><br><br><br>
<br><br><br><br><br>

.small[

Codigo reproducible instalando estos paquetes.

```{r, eval = F}
install.packages("pacman")
pacman::p_load(tidyverse, sf, leaflet, tmap, ggspatial)

# Agromet
remotes::instal_github("AgRoMeteorologiaINTA/agromet")
```

Or, you can try out the code using this r # embed_file("intro-to-mlr-notebook.Rmd", text = "R-notebook") `r fontawesome::fa("download")`

]

]


---
name: why-MLR

## ¿Por qué hacer mapas?

.pull-left[

```{r, echo = F, out.width="80%", fig.cap="Mapa de Cólera Londers 1854"}
include_graphics("https://upload.wikimedia.org/wikipedia/commons/c/c7/Snow-cholera-map.jpg")
```

]

???

Maps have been used for several thousand years for a wide variety of purposes. Historic examples include maps of buildings and land ownership in the Old Babylonian dynasty more than 3000 years ago and Ptolemy’s world map in his masterpiece Geography nearly 2000 years ago

En uno de los primeros análisis de datos espaciales el Dr. Snow mapeó los casos de cólera en el barrio Soho de Londres y la disposición de las estaciones de bombeo.

De la visualización de ambas capas de información descubró que el pozo contaminado se encontraba en la calle Broad.

--

.pull-right[


- Ideal para visualizar, explorar o analizar datos espaciales 

- Permiten ver tendencias, patrones, detectar anomalías, outliers, etc

- Modo efectivo para comunicar resultados de análisis de datos espaciales

{{content}}

]

--

- **¿Por que en R?** {{content}}

--

reproducibilidad!

{{content}}

--

<br>

`r fontawesome::fa("exclamation-triangle")` **Cuidado**: Mapas mal preparados pueden dificultar la comunicación.

- mala ubicación de los componentes

- tamaño y legibilidad del texto

- falta de referencias/leyenda

- mala elección de colores y simbología

`r fontawesome::fa("book")` Acá una guía de estilo de [Journal of Maps](https://files.taylorandfrancis.com/TJOM-suppmaterial-quick-guide.pdf)


???


Los mapas permien ver tendencias, patrones, valores extraños, etc

Ejemplo de tendencia

Ejemplo clásico pozos y colera

---
name: spatial

## Datos espaciales en R: evolución 

.footnote[

Fuente: [R-Bloggers](https://www.r-bloggers.com/2023/06/upcoming-changes-to-popular-r-packages-for-spatial-data-what-you-need-to-do/), [Bivand et al. (2021)](https://link.springer.com/article/10.1007/s10109-020-00336-0#Sec2)

]

---
template: spatial

.pull-left[

```{r, echo = F, out.width="20%", include = F}
include_graphics(c("https://avatars.githubusercontent.com/u/520851?v=4", "https://www.nhh.no/contentassets/4612ef8b3afd4bb99cd97c72f856816e/s1155.jpg?width=400&factor=2&quality=90"))
```

```{r, echo = F, out.width="30%", fig.align="center"}
# solo sp
grafico1 <- create_graph(attr_theme = "tb") |> 
  add_node(label = "sp")
render_graph(grafico1)
```

]

.pull-right[

Proveedor de las clases `Spatial*` y `Spatial*DataFrame` y sus métodos

```{r}
library(sp)
data("meuse")
coordinates(meuse) <- ~x+y
proj4string(meuse) <- CRS("+init=epsg:28992")
meuse
```

Slots para: `bbox`, `coords`, `proj4string` y `data` (los que `*DataFrame`

]


---
template: spatial

.pull-left[

```{r, echo = F}
# sp a maptools
grafico2 <- grafico1 |>  
  add_node(label = "maptools") |> 
  add_edge(from = 1, to = 2)
render_graph(grafico2)
```

]

.pull-right[

- `maptools` daba utilidades varias para manejar vectores

]

---
template: spatial

.pull-left[

```{r, echo = F}
# sp rgeos/gdal
grafico3 <- grafico2 |>  
  add_node(label = "rgeos") |> 
  add_edge(from = 1, to = 3) |> 
  add_node(label = "rgdal") |> 
  add_edge(from = 1, to = 4) |> 
  add_node(label = "raster") |> 
  add_edge(from = 1, to = 5) 
render_graph(grafico3)
```

]

.pull-right[

- `maptools` daba utilidades varias para manejar vectores 

- `rgdal` para leer/guardar datos espaciales

- `rgeos` para operar vectores

- `raster` para operar rasters

]

---
template: spatial

.pull-left[

```{r, echo = F}
# raster spacetime
grafico4 <- grafico3 |>
  add_node(label = "spacetime") 
render_graph(grafico4)
```

]

.pull-right[

- `spacetime` aporta clases y metodos para datos espacio-temporales

]

---
template: spatial

.pull-left[

```{r, echo = F}
# sf
grafico5 <- grafico4 |>  
  add_node(label = "sf") |> 
  add_edge(from = 3, to = 7) |> 
  add_edge(from = 4, to = 7) |> 
  set_node_attrs(nodes = c(2,3,4), node_attr = style, value = "dashed")
render_graph(grafico5)
```

]

.pull-right[

Nueva generación...

- `maptools/rgeos/rgdal` se retiran en Oct 2023

- `sf` (simple feature) evolución de `sp`, combina GEOS y GDAL `tidyverse`-friendly

]

---
template: spatial

.pull-left[

```{r, echo = F}
# stars
grafico6 <- grafico5 |>  
  add_node(label = "stars") |> 
  add_edge(from = 5, to = 8) |> 
  add_edge(from = 6, to = 8) |> 
  add_edge(from = 7, to = 8)
render_graph(grafico6)
```

]

.pull-right[

Nueva generación...

- `maptools/rgeos/rgdal` se retiran en Oct 2023

- `sf` (simple feature) evolución de `sp`, combina GEOS y GDAL `tidyverse`-friendly

- `stars` vectores y rasters espaciotemporales

]

---
template: spatial

.pull-left[

```{r, echo = F}
# terra
grafico7 <- grafico6 |>  
  add_node(label = "terra") |> 
  add_edge(from = 5, to = 9) 
render_graph(grafico7)
```

]

.pull-right[

Nueva generación...

- `maptools/rgeos/rgdal` se retiran en Oct 2023

- `sf` (simple feature) evolución de `sp`, combina GEOS y GDAL `tidyverse`-friendly

- `stars` vectores y rasters espaciotemporales

- `terra` evolución de `raster`

]


---
name: estatico-interact

## Mapas estáticos vs interactivos

```{r, echo = F}
library(tmap)
data("World")
mapamundi <- tm_shape(World) + tm_polygons("continent") 
```

---
template: estatico-interact

```{r, echo = F, fig.width=12}
tmap_mode("plot") # modo estático
mapamundi 
```

---
template: estatico-interact

```{r, echo = F, out.width="90%"}
tmap_mode("view") # modo interactivo
mapamundi
```


---
## Paquetes para mapear

.pull-left[

Se pueden hacer "mapas" usando funciones básicas (y mucho código) o como paquetes dedicados

Algunos paquetes con capacidades para mapear:

- `sp` a través de `spplot()`
- `sf` usando `plot()`
- `raster`
- `ggplot2`, marida con `sf` usando `geom_sf()`
- `ggspatial`
- `tmap`, muy completo
- `mapview`,  
- `leaflet`,
- `rbokeh`, un port the paquete `bokeh` de Python
- ...

]

--

.pull-right[

```{r, echo = F, include=T}
estaticos <- c("sp", "sf", "raster", "ggplot2", "ggspatial", "tmap")
interactivos <- c("tmap", "leaflet", "mapview", "rbokeh")

# Chart
x <- list(interactivos = interactivos, estaticos = estaticos)
ggvenn(x, show_elements = T, label_sep = "\n", text_size= 6)
```

]

---
name: spplot

## `sp::spplot()`

---
template: spplot

.pull-left[

- Usa el paquete `grid` (similar a `lattice`) 

- Soporta vectores y raster como objetos `Spatial*`

- Gráficos y multipanel

- Rápido

- Sintaxis compleja

]

.pull-right[

```{r}
library(sp)

# Datos punto
data("meuse")
coordinates(meuse) <- ~x+y
proj4string(meuse) <- CRS("+init=epsg:28992")

# Datos raster
data("meuse.grid")
coordinates(meuse.grid) = ~x+y
proj4string(meuse.grid) <- CRS("+init=epsg:28992")
gridded(meuse.grid) = TRUE
```

]

---
template: spplot

.pull-left[

Algo básico...

```{r sp1, eval = F}
spplot(meuse, zcol = "zinc")
```

]

.pull-right[

```{r ref.label="sp1", eval = T, echo = F}
```

]

---
template: spplot

.pull-left[

Algo mejor...

```{r sp2, eval = F}
spplot(
  meuse, zcol = "zinc",
  cuts = seq(0,2000, by = 250), #<<
  scales = list(draw = T),      #<<
  ylab = "Northing (m)",        #<<
  xlab = "Easting (m)",         #<<
  key.space = "right"           #<<
)
```

]

.pull-right[

```{r ref.label="sp2", eval = T, echo = F}
```

]

---
template: spplot

.pull-left[

Más de una variable...

```{r sp3, eval = F}
spplot(
  meuse, zcol = c("zinc", "lead"), #<<
  scales = list(draw = T), 
  ylab = "Northing (m)", xlab = "Easting (m)",
  key.space = "right"
)
```

]

--

.pull-right[

```{r ref.label="sp3", eval = T, echo = F}
```

]

---
template: spplot

.pull-left[

Ploteando rasters

```{r sp4, eval = F}
p1 <- spplot(
  meuse.grid, zcol= "dist",
  scales = list(draw = T), key.space = "right",
  ylab = "Northing (m)", xlab = "Easting (m)"
)
p1
```

]

--

.pull-right[

```{r ref.label="sp4", eval = T, echo = F}
```

]

---
template: spplot

.pull-left[

Ploteando rasters


```{r sp5, eval = F}
p2 <- spplot(
  meuse.grid, zcol= "ffreq",
  scales = list(draw = T), key.space = "right",
  ylab = "Northing (m)", xlab = "Easting (m)"
)
p2
```

]

--

.pull-right[

```{r ref.label="sp5", eval = T, echo = F}
```

]


---
template: spplot

Combinando graficos con `gridExtra`

```{r sp6, fig.width=12, fig.retina=2}
library(gridExtra)
grid.arrange(p1, p2, ncol = 2)
```

---
name: sfplot

## `sf::plot()`


---
template: sfplot

.pull-left[

- Sólo para vectores (puntos, lineas, poligonos, etc)

- Muy rápido, ideal para explorar

- Sintaxis similar a `base::plot()`, se agregan elementos....

```{r sf1, eval = F}
library(sf)
meuse_sf <- st_as_sf(meuse)
plot(meuse_sf)
```

]

--

.pull-right[

```{r ref.label="sf1", eval = T, echo = F}
```

]

---
name: ggsf

## `ggplot2` + `sf` + `ggspatial`

---
template: ggsf

.pull-left[

- Vectores (puntos, lineas, poligonos) y rasters

- Sigue la lógica de _grammar of graphics_ 

- `geom_sf()`/`coords_sf()`

- `ggspatial` permite agregar mapa base, escalas, etc.

```{r ggsf1, eval = F}
library(sf)
library(ggplot2)
meuse_sf <- st_as_sf(meuse)
ggplot(meuse_sf) +
  aes(color = zinc) +
  geom_sf() +            #<<
  coord_sf(datum = NULL) #<<
```

]

--

.pull-right[

```{r ref.label="ggsf1", eval = T, echo = F}
```

]

---
template: ggsf

.pull-left[

- Vectores (puntos, lineas, poligonos) y rasters

- Sigue la lógica de _grammar of graphics_ 

- `geom_sf()`/`coords_sf()`

- `ggspatial` permite agregar mapa base, escalas, etc.

```{r ggsf2, eval = F}
library(ggspatial)
ggplot(meuse_sf) +
  annotation_map_tile("osm", zoomin = 0) +  #<<
  aes(color = zinc) +
  geom_sf() +
  coord_sf()   #<<
```

]

--

.pull-right[

```{r ref.label="ggsf2", eval = T, echo = F}
```

]

---
template: ggsf

.pull-left[

Podemos usar facets

```{r ggsf3, eval = F}
library(dplyr)
meuse_sf |> 
  pivot_longer(cadmium:zinc) |> 
  ggplot() +
  aes(color = value) +
  geom_sf() +
  facet_wrap(~ name)
```

]

--

.pull-right[

```{r ref.label="ggsf32", eval = T, echo = F}
```

]

---
template: ggsf

.pull-left[

O `patchwork` para tener una escala por panel...

```{r ggsf4, eval = F}
p_base <- ggplot(meuse_sf) + geom_sf() + theme_bw()
p_zinc <- p_base + aes(color = zinc) 
p_lead <- p_base +aes(color = lead)
p_cadmium <- p_base + aes(color = cadmium) 
p_copper <- p_base + aes(color = copper)

library(patchwork)
(p_zinc + p_cadmium) /(p_copper + p_lead)
```

]

.pull-right[

```{r ref.label="ggsf4", eval = T, echo = F}
```

]

---
name: tmap

## `tmap`

---
template: tmap

.pull-left[

- Vectores (puntos, lineas, poligonos) y rasters

- Sigue la lógica de _grammar of graphics_ 

- Mapas estáticos y dinámicos (leaflet)

- `tm_shape()` es la base que define el set de datos, luego `+ tm_*` agregan capas 

- El orden de los factorers altera el producto

```{r tm1, eval = F}
library(tmap)
library(agromet)
tmap_mode("plot") # modo estático, "view" para dinámico

# Poligonos usando Agromet
provs <- mapa_provincias()
dptos <- mapa_departamentos()

mapa_base <- tm_shape(provs) +
  tm_borders()
mapa_base
```

]

--

.pull-right[

```{r ref.label="tm1", eval = T, echo = F}
```

]


---
template: tmap

.pull-left[

Agregando los estaciones con `tm_dots()`

```{r tm2, eval = F}
estaciones <- metadatos_nh() |>
  st_as_sf(coords = c("lon", "lat")) |> 
  st_set_crs(4326)
colores <- c(INTA = "blue", SMN = "red")

mapa_est_org <- tm_shape(estaciones) +
  tm_dots("organismo", palette = colores) +
  tm_layout(legend.outside = T)

mapa_base + mapa_est_org
```

]

--

.pull-right[

```{r ref.label="tm2", eval = T, echo = F}
```

]

---
template: tmap

.pull-left[

Un ejemplo con escala numérica...

```{r tm3, eval = F}
mapa_est_alt <- tm_shape(estaciones) +
  tm_bubbles("altura") +
  tm_layout(legend.outside = T)

mapa_base + mapa_est_alt
```

]

--

.pull-right[

```{r ref.label="tm3", eval = T, echo = F}
```

]

---
template: tmap

.pull-left[

Y ambas a la vesz?...

```{r tm4, eval = F}
mapa_est_alt_org <- tm_shape(estaciones) +
  tm_bubbles("altura", col = "organismo", palette = colores) +
  tm_layout(legend.outside = T)

mapa_base + mapa_est_alt_org
```

]

--

.pull-right[

```{r ref.label="tm4", eval = T, echo = F}
```

]

---
template: tmap

.pull-left[

Podemos usar facets... 

```{r tm5, eval = F}
provincias <- c("Buenos Aires", "Santa Fe", "Córdoba")

tm_shape(provs |> filter(name %in% provincias)) +
  tm_borders() +
  tm_facets("name") + #<<
tm_shape(estaciones |> filter(provincia %in% provincias)) +
  tm_dots("organismo", size = 0.25, palette = colores) +
  tm_facets("provincia", ncol = 1) #<<
```

]

--

.pull-right[

```{r ref.label="tm5", eval = T, echo = F}
```

]

---
template: tmap

.pull-left[

Para agregar elementos adicionales

- `tm_graticule()` para grilla coordenadas, permite reproyectar

- `tm_compass()` para rosa

- `tm_scalebar()` para escala

- `tm_layout()` títulos, etc.

```{r tm6, eval = F}
mapa_base + 
  mapa_est_org +
  tm_graticules() +
  tm_compass(type = "arrow", size = 2, position = c("left","top")) +
  tm_scale_bar() +
  tm_layout(main.title = "Estaciones NH", main.title.size = 1)
```

]

--

.pull-right[

```{r ref.label="tm6", eval = T, echo = F}
```

]

---
template: tmap

.pull-left[

También podemos hacer mapas dentro de mapas usando `grid::viewport()`

```{r tm7, eval = F}
# Mapa principal
mapa_bsas <- tm_shape(provs |> filter(name == "Buenos Aires")) +
  tm_borders() +
  tm_shape(estaciones |> filter(provincia == "Buenos Aires")) +
  tm_dots("organismo", size = 0.05, palette = colores) +
  tm_text("estacion", size = 0.75, ymod = 0.5, remove.overlap = T) + #<<
  tm_layout(frame = F)

# Minimapa
provs <- mutate(provs, foco = ifelse(name == "Buenos Aires", "gray", "white"))
mapa_arg <- tm_shape(provs) +
  tm_polygons("foco")

# Imprimir mapa principal y submapa
mapa_bsas #<<
print(mapa_arg, vp = grid::viewport(x = 0.9, y = 0.2, width = 0.3, height = 0.3)) #<<
```

]

--

.pull-right[

```{r ref.label="tm7", eval = T, echo = F}
```

]

--- 
name: mapview

## `mapview`

---
template: mapview

.pull-left[

- Vectores (puntos, líneas, polígonos) y rasters

- Sigue la lógica de _grammar of graphics_ 

- `geom_sf()`/`coords_sf()`

- `ggspatial` permite agregar mapa base, escalas, etc.

```{r mpaview, eval = F}
library(sf)
library(ggplot2)
meuse_sf <- st_as_sf(meuse)
ggplot(meuse_sf) +
  aes(color = zinc) +
  geom_sf() +            #<<
  coord_sf(datum = NULL) #<<
```

]

--

.pull-right[

```{r ref.label="ggsf1", eval = T, echo = F}
```

]

---
name: leaflet

## `leaflet`

---
template: ggsf

.pull-left[

- Vectores (puntos, lineas, poligonos) y rasters

- Sigue la lógica de _grammar of graphics_ 

- `geom_sf()`/`coords_sf()`

- `ggspatial` permite agregar mapa base, escalas, etc.

```{r ggsf1, eval = F}
library(sf)
library(ggplot2)
meuse_sf <- st_as_sf(meuse)
ggplot(meuse_sf) +
  aes(color = zinc) +
  geom_sf() +            #<<
  coord_sf(datum = NULL) #<<
```

]

--

.pull-right[

```{r ref.label="ggsf1", eval = T, echo = F}
```

]